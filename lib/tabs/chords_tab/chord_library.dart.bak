// ============================
// lib/tabs/chords_tab/chord_library.dart
// ============================

import 'package:flutter/foundation.dart';
import 'package:flutter/material.dart' show BuildContext, Color; // BuildContext for AppSettingsScope
import 'package:music_theoretically/state/app_settings.dart';

/// Note names used across the app. Keep enharmonics simple for v1.
const List<String> kChromatic = [
  'C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'
];

/// Standard tuning low→high (6→1). Index 0 = low E, 5 = high E.
const List<String> kStandardTuning = ['E', 'A', 'D', 'G', 'B', 'E'];

int _noteIndex(String note) => kChromatic.indexOf(note);

String _pcAt(String openNote, int absFret) {
  final base = _noteIndex(openNote);
  if (base < 0) return openNote; // fallback if unknown
  return kChromatic[(base + absFret) % 12];
}

/// Calculates the pitch classes in a chord given a root note and interval list
Set<String> getChordNotes(String root, List<int> intervals) {
  final rootIndex = _noteIndex(root);
  if (rootIndex < 0) return {};
  return intervals.map((i) => kChromatic[(rootIndex + (i % 12)) % 12]).toSet();
}

/// Chord qualities we’ll support initially. Extend as needed.
enum ChordQuality {
  maj, // major
  min, // minor
  dim, // diminished (triad)
  aug, // augmented (triad)
  sus2,
  sus4,
  six, // major 6th
  m6, // minor 6th
  seven, // dominant 7th
  m7, // minor 7th
  maj7, // major 7th
  m7b5, // half diminished
  dim7, // diminished 7th
  add9,
  mAdd9,
}

/// Interval formulas (in semitones from root) for supported qualities.
const Map<ChordQuality, List<int>> kChordFormulas = {
  ChordQuality.maj: [0, 4, 7],
  ChordQuality.min: [0, 3, 7],
  ChordQuality.dim: [0, 3, 6],
  ChordQuality.aug: [0, 4, 8],
  ChordQuality.sus2: [0, 2, 7],
  ChordQuality.sus4: [0, 5, 7],
  ChordQuality.six: [0, 4, 7, 9],
  ChordQuality.m6: [0, 3, 7, 9],
  ChordQuality.seven: [0, 4, 7, 10], // dominant 7th
  ChordQuality.m7: [0, 3, 7, 10],
  ChordQuality.maj7: [0, 4, 7, 11],
  ChordQuality.m7b5: [0, 3, 6, 10],
  ChordQuality.dim7: [0, 3, 6, 9],
  ChordQuality.add9: [0, 4, 7, 14],
  ChordQuality.mAdd9: [0, 3, 7, 14],
};

@immutable
class Position {
  /// 0 = low E (6th string) … 5 = high E (1st string)
  final int stringIndex;

  /// Fret relative to the 5-fret window. 0 = open, >=1 = within window.
  /// If [muted] is true, this may be ignored.
  final int fretRelative;

  /// Optional finger number 1..4
  final int? finger;

  /// If true, string is not played ("x").
  final bool muted;

  const Position({
    required this.stringIndex,
    required this.fretRelative,
    this.finger,
    this.muted = false,
  });
}

@immutable
class Barre {
  /// Inclusive string span (low index ≤ high index). Use 0..5.
  final int fromString;

  /// Renamed from `toString` to avoid clashing with Object.toString.
  final int toStringIndex;

  /// Fret relative to window (>=1 typically). Finger performing the barre.
  final int fretRelative;

  final int? finger;

  const Barre({
    required this.fromString,
    required this.toStringIndex,
    required this.fretRelative,
    this.finger,
  });
}

@immutable
class ChordVoicing {
  /// The 5-fret diagram’s base fret (1 = includes nut / open area).
  final int baseFret;

  /// Positions across strings. Prefer to list all 6 strings for clarity.
  final List<Position> positions;

  final List<Barre> barres;

  /// Optional label, e.g. "E-shape @ 3rd" or "Open".
  final String? label;

  /// Optional index (0..5) of the string containing the chord root.
  final int? rootStringIndex;

  const ChordVoicing({
    required this.baseFret,
    required this.positions,
    this.barres = const [],
    this.label,
    this.rootStringIndex,
  });
}

@immutable
class ChordDefinition {
  final String root; // e.g., 'C'
  final ChordQuality quality;
  final List<ChordVoicing> voicings;

  const ChordDefinition({
    required this.root,
    required this.quality,
    required this.voicings,
  });
}

/// Convert a relative fret to absolute fret number on the neck for rendering
/// or coloration. baseFret=1 means window starts at nut.
int relativeToAbsoluteFret({required int baseFret, required int fretRelative}) {
  if (fretRelative <= 0) return fretRelative; // 0=open stays 0
  return baseFret == 1 ? fretRelative : (baseFret + fretRelative - 1);
}

/// For a given voicing, compute the pitch classes per string in standard tuning.
/// Returns a list of nullable note names for strings 0..5 (low→high).
List<String?> pitchClassesForVoicing(
  ChordVoicing v, {
  List<String> tuning = kStandardTuning,
}) {
  final pc = List<String?>.filled(6, null);
  for (final p in v.positions) {
    if (p.muted) {
      pc[p.stringIndex] = null;
      continue;
    }
    final abs = relativeToAbsoluteFret(baseFret: v.baseFret, fretRelative: p.fretRelative);
    if (p.fretRelative == 0) {
      pc[p.stringIndex] = tuning[p.stringIndex];
    } else {
      pc[p.stringIndex] = _pcAt(tuning[p.stringIndex], abs);
    }
  }
  return pc;
}

// ─────────────────────────────────────────────────────────────────────────────
// Colors — rely ONLY on AppSettings
// ─────────────────────────────────────────────────────────────────────────────

/// UI-friendly resolver (when you have a BuildContext).
Color colorForNote(BuildContext context, String? note) {
  if (note == null) return const Color(0xFF999999);
  return AppSettingsScope.of(context).colorFor(note);
}

/// Non-UI resolver (when you already hold an AppSettings instance).
Color colorForNoteFromSettings(AppSettings settings, String? note) {
  if (note == null) return const Color(0xFF999999);
  return settings.colorFor(note);
}

/// Text color chosen for legibility against the note’s fill color.
Color textColorForNote(BuildContext context, String? note) {
  final bg = colorForNote(context, note);
  return bg.computeLuminance() > 0.5 ? const Color(0xFF000000) : const Color(0xFFFFFFFF);
}

// ─────────────────────────────────────────────────────────────────────────────
// Seed Library — Root → Quality → Definition (with multiple voicings)
// Keep the starter set sane; expand over time.
// String indices: 0=lowE, 1=A, 2=D, 3=G, 4=B, 5=highE
// ─────────────────────────────────────────────────────────────────────────────

final Map<String, Map<ChordQuality, ChordDefinition>> chordLibrary = {
  // ===================== C CHORDS =====================
  'C': {
    // C major
    ChordQuality.maj: ChordDefinition(
      root: 'C',
      quality: ChordQuality.maj,
      voicings: [
        // Open C: x 3 2 0 1 0
        ChordVoicing(
          baseFret: 1,
          label: 'Open',
          rootStringIndex: 1, // A-string C
          positions: const [
            Position(stringIndex: 0, fretRelative: 0, muted: true), // x
            Position(stringIndex: 1, fretRelative: 3, finger: 3),
            Position(stringIndex: 2, fretRelative: 2, finger: 2),
            Position(stringIndex: 3, fretRelative: 0),
            Position(stringIndex: 4, fretRelative: 1, finger: 1),
            Position(stringIndex: 5, fretRelative: 0),
          ],
        ),
        // A-shape barre @ 3rd: x 3 5 5 5 3
        ChordVoicing(
          baseFret: 3,
          label: 'A-shape @ 3rd',
          barres: const [Barre(fromString: 1, toStringIndex: 5, fretRelative: 1, finger: 1)],
          positions: const [
            Position(stringIndex: 0, fretRelative: 0, muted: true),
            Position(stringIndex: 1, fretRelative: 1, finger: 1),
            Position(stringIndex: 2, fretRelative: 3, finger: 3),
            Position(stringIndex: 3, fretRelative: 3, finger: 4),
            Position(stringIndex: 4, fretRelative: 3, finger: 2),
            Position(stringIndex: 5, fretRelative: 1, finger: 1),
          ],
        ),
        // E-shape barre @ 8th: 8 10 10 9 8 8
        ChordVoicing(
          baseFret: 8,
          label: 'E-shape @ 8th',
          barres: const [Barre(fromString: 0, toStringIndex: 5, fretRelative: 1, finger: 1)],
          positions: const [
            Position(stringIndex: 0, fretRelative: 1, finger: 1),
            Position(stringIndex: 1, fretRelative: 3, finger: 3),
            Position(stringIndex: 2, fretRelative: 3, finger: 4),
            Position(stringIndex: 3, fretRelative: 2, finger: 2),
            Position(stringIndex: 4, fretRelative: 1, finger: 1),
            Position(stringIndex: 5, fretRelative: 1, finger: 1),
          ],
        ),
      ],
    ),

    // C minor (barre shapes)
    ChordQuality.min: ChordDefinition(
      root: 'C',
      quality: ChordQuality.min,
      voicings: const [
        // A-shape min @ 3rd: x 3 5 5 4 3
        ChordVoicing(
          baseFret: 3,
          label: 'Am-shape @ 3rd',
          barres: [Barre(fromString: 1, toStringIndex: 5, fretRelative: 1, finger: 1)],
          positions: [
            Position(stringIndex: 0, fretRelative: 0, muted: true),
            Position(stringIndex: 1, fretRelative: 1, finger: 1),
            Position(stringIndex: 2, fretRelative: 3, finger: 3),
            Position(stringIndex: 3, fretRelative: 3, finger: 4),
            Position(stringIndex: 4, fretRelative: 2, finger: 2),
            Position(stringIndex: 5, fretRelative: 1, finger: 1),
          ],
        ),
        // Em-shape @ 8th: 8 10 10 8 8 8
        ChordVoicing(
          baseFret: 8,
          label: 'Em-shape @ 8th',
          barres: [Barre(fromString: 0, toStringIndex: 5, fretRelative: 1, finger: 1)],
          positions: [
            Position(stringIndex: 0, fretRelative: 1, finger: 1),
            Position(stringIndex: 1, fretRelative: 3, finger: 3),
            Position(stringIndex: 2, fretRelative: 3, finger: 4),
            Position(stringIndex: 3, fretRelative: 1, finger: 1),
            Position(stringIndex: 4, fretRelative: 1, finger: 1),
            Position(stringIndex: 5, fretRelative: 1, finger: 1),
          ],
        ),
      ],
    ),

    // C7 (dominant) — x 3 2 3 1 0
    ChordQuality.seven: ChordDefinition(
      root: 'C',
      quality: ChordQuality.seven,
      voicings: const [
        ChordVoicing(
          baseFret: 1,
          label: 'Open 7',
          positions: [
            Position(stringIndex: 0, fretRelative: 0, muted: true),
            Position(stringIndex: 1, fretRelative: 3, finger: 3),
            Position(stringIndex: 2, fretRelative: 2, finger: 2),
            Position(stringIndex: 3, fretRelative: 3, finger: 4),
            Position(stringIndex: 4, fretRelative: 1, finger: 1),
            Position(stringIndex: 5, fretRelative: 0),
          ],
        ),
      ],
    ),
  },

  // ===================== D CHORDS =====================
  'D': {
    // D major: x x 0 2 3 2
    ChordQuality.maj: ChordDefinition(
      root: 'D',
      quality: ChordQuality.maj,
      voicings: const [
        ChordVoicing(
          baseFret: 1,
          label: 'Open',
          positions: [
            Position(stringIndex: 0, fretRelative: 0, muted: true),
            Position(stringIndex: 1, fretRelative: 0, muted: true),
            Position(stringIndex: 2, fretRelative: 0),
            Position(stringIndex: 3, fretRelative: 2, finger: 1),
            Position(stringIndex: 4, fretRelative: 3, finger: 3),
            Position(stringIndex: 5, fretRelative: 2, finger: 2),
          ],
        ),
        // A-shape @ 5th: x 5 7 7 7 5
        ChordVoicing(
          baseFret: 5,
          label: 'A-shape @ 5th',
          barres: [Barre(fromString: 1, toStringIndex: 5, fretRelative: 1, finger: 1)],
          positions: [
            Position(stringIndex: 0, fretRelative: 0, muted: true),
            Position(stringIndex: 1, fretRelative: 1, finger: 1),
            Position(stringIndex: 2, fretRelative: 3, finger: 3),
            Position(stringIndex: 3, fretRelative: 3, finger: 4),
            Position(stringIndex: 4, fretRelative: 3, finger: 2),
            Position(stringIndex: 5, fretRelative: 1, finger: 1),
          ],
        ),
        // E-shape @ 10th: 10 12 12 11 10 10
        ChordVoicing(
          baseFret: 10,
          label: 'E-shape @ 10th',
          barres: [Barre(fromString: 0, toStringIndex: 5, fretRelative: 1, finger: 1)],
          positions: [
            Position(stringIndex: 0, fretRelative: 1, finger: 1),
            Position(stringIndex: 1, fretRelative: 3, finger: 3),
            Position(stringIndex: 2, fretRelative: 3, finger: 4),
            Position(stringIndex: 3, fretRelative: 2, finger: 2),
            Position(stringIndex: 4, fretRelative: 1, finger: 1),
            Position(stringIndex: 5, fretRelative: 1, finger: 1),
          ],
        ),
      ],
    ),

    // D minor: x x 0 2 3 1
    ChordQuality.min: ChordDefinition(
      root: 'D',
      quality: ChordQuality.min,
      voicings: const [
        ChordVoicing(
          baseFret: 1,
          label: 'Open',
          positions: [
            Position(stringIndex: 0, fretRelative: 0, muted: true),
            Position(stringIndex: 1, fretRelative: 0, muted: true),
            Position(stringIndex: 2, fretRelative: 0),
            Position(stringIndex: 3, fretRelative: 2, finger: 2),
            Position(stringIndex: 4, fretRelative: 3, finger: 3),
            Position(stringIndex: 5, fretRelative: 1, finger: 1),
          ],
        ),
        // Am-shape @ 5th: x 5 7 7 6 5
        ChordVoicing(
          baseFret: 5,
          label: 'Am-shape @ 5th',
          barres: [Barre(fromString: 1, toStringIndex: 5, fretRelative: 1, finger: 1)],
          positions: [
            Position(stringIndex: 0, fretRelative: 0, muted: true),
            Position(stringIndex: 1, fretRelative: 1, finger: 1),
            Position(stringIndex: 2, fretRelative: 3, finger: 3),
            Position(stringIndex: 3, fretRelative: 3, finger: 4),
            Position(stringIndex: 4, fretRelative: 2, finger: 2),
            Position(stringIndex: 5, fretRelative: 1, finger: 1),
          ],
        ),
      ],
    ),

    // D7: x x 0 2 1 2
    ChordQuality.seven: ChordDefinition(
      root: 'D',
      quality: ChordQuality.seven,
      voicings: const [
        ChordVoicing(
          baseFret: 1,
          label: 'Open 7',
          positions: [
            Position(stringIndex: 0, fretRelative: 0, muted: true),
            Position(stringIndex: 1, fretRelative: 0, muted: true),
            Position(stringIndex: 2, fretRelative: 0),
            Position(stringIndex: 3, fretRelative: 2, finger: 2),
            Position(stringIndex: 4, fretRelative: 1, finger: 1),
            Position(stringIndex: 5, fretRelative: 2, finger: 3),
          ],
        ),
      ],
    ),
  },

  // ===================== E CHORDS =====================
  'E': {
    // E major: 0 2 2 1 0 0
    ChordQuality.maj: ChordDefinition(
      root: 'E',
      quality: ChordQuality.maj,
      voicings: const [
        ChordVoicing(
          baseFret: 1,
          label: 'Open',
          positions: [
            Position(stringIndex: 0, fretRelative: 0),
            Position(stringIndex: 1, fretRelative: 2, finger: 2),
            Position(stringIndex: 2, fretRelative: 2, finger: 3),
            Position(stringIndex: 3, fretRelative: 1, finger: 1),
            Position(stringIndex: 4, fretRelative: 0),
            Position(stringIndex: 5, fretRelative: 0),
          ],
        ),
        // A-shape @ 7th: x 7 9 9 9 7
        ChordVoicing(
          baseFret: 7,
          label: 'A-shape @ 7th',
          barres: [Barre(fromString: 1, toStringIndex: 5, fretRelative: 1, finger: 1)],
          positions: [
            Position(stringIndex: 0, fretRelative: 0, muted: true),
            Position(stringIndex: 1, fretRelative: 1, finger: 1),
            Position(stringIndex: 2, fretRelative: 3, finger: 3),
            Position(stringIndex: 3, fretRelative: 3, finger: 4),
            Position(stringIndex: 4, fretRelative: 3, finger: 2),
            Position(stringIndex: 5, fretRelative: 1, finger: 1),
          ],
        ),
      ],
    ),

    // E minor: 0 2 2 0 0 0
    ChordQuality.min: ChordDefinition(
      root: 'E',
      quality: ChordQuality.min,
      voicings: const [
        ChordVoicing(
          baseFret: 1,
          label: 'Open',
          positions: [
            Position(stringIndex: 0, fretRelative: 0),
            Position(stringIndex: 1, fretRelative: 2, finger: 2),
            Position(stringIndex: 2, fretRelative: 2, finger: 3),
            Position(stringIndex: 3, fretRelative: 0),
            Position(stringIndex: 4, fretRelative: 0),
            Position(stringIndex: 5, fretRelative: 0),
          ],
        ),
      ],
    ),

    // E7: 0 2 0 1 0 0
    ChordQuality.seven: ChordDefinition(
      root: 'E',
      quality: ChordQuality.seven,
      voicings: const [
        ChordVoicing(
          baseFret: 1,
          label: 'Open 7',
          positions: [
            Position(stringIndex: 0, fretRelative: 0),
            Position(stringIndex: 1, fretRelative: 2, finger: 2),
            Position(stringIndex: 2, fretRelative: 0),
            Position(stringIndex: 3, fretRelative: 1, finger: 1),
            Position(stringIndex: 4, fretRelative: 0),
            Position(stringIndex: 5, fretRelative: 0),
          ],
        ),
      ],
    ),
  },

  // ===================== F CHORDS =====================
  'F': {
    // F major (barre): 1 3 3 2 1 1
    ChordQuality.maj: ChordDefinition(
      root: 'F',
      quality: ChordQuality.maj,
      voicings: const [
        ChordVoicing(
          baseFret: 1,
          label: 'E-shape @ 1st',
          barres: [Barre(fromString: 0, toStringIndex: 5, fretRelative: 1, finger: 1)],
          positions: [
            Position(stringIndex: 0, fretRelative: 1, finger: 1),
            Position(stringIndex: 1, fretRelative: 3, finger: 3),
            Position(stringIndex: 2, fretRelative: 3, finger: 4),
            Position(stringIndex: 3, fretRelative: 2, finger: 2),
            Position(stringIndex: 4, fretRelative: 1, finger: 1),
            Position(stringIndex: 5, fretRelative: 1, finger: 1),
          ],
        ),
        // A-shape @ 8th: x 8 10 10 10 8
        ChordVoicing(
          baseFret: 8,
          label: 'A-shape @ 8th',
          barres: [Barre(fromString: 1, toStringIndex: 5, fretRelative: 1, finger: 1)],
          positions: [
            Position(stringIndex: 0, fretRelative: 0, muted: true),
            Position(stringIndex: 1, fretRelative: 1, finger: 1),
            Position(stringIndex: 2, fretRelative: 3, finger: 3),
            Position(stringIndex: 3, fretRelative: 3, finger: 4),
            Position(stringIndex: 4, fretRelative: 3, finger: 2),
            Position(stringIndex: 5, fretRelative: 1, finger: 1),
          ],
        ),
      ],
    ),

    // F minor (barre): 1 3 3 1 1 1
    ChordQuality.min: ChordDefinition(
      root: 'F',
      quality: ChordQuality.min,
      voicings: const [
        ChordVoicing(
          baseFret: 1,
          label: 'Em-shape @ 1st',
          barres: [Barre(fromString: 0, toStringIndex: 5, fretRelative: 1, finger: 1)],
          positions: [
            Position(stringIndex: 0, fretRelative: 1, finger: 1),
            Position(stringIndex: 1, fretRelative: 3, finger: 3),
            Position(stringIndex: 2, fretRelative: 3, finger: 4),
            Position(stringIndex: 3, fretRelative: 1, finger: 1),
            Position(stringIndex: 4, fretRelative: 1, finger: 1),
            Position(stringIndex: 5, fretRelative: 1, finger: 1),
          ],
        ),
      ],
    ),
  },

  // ===================== G CHORDS =====================
  'G': {
    // G major: 3 2 0 0 0 3
    ChordQuality.maj: ChordDefinition(
      root: 'G',
      quality: ChordQuality.maj,
      voicings: const [
        ChordVoicing(
          baseFret: 1,
          label: 'Open',
          positions: [
            Position(stringIndex: 0, fretRelative: 3, finger: 3),
            Position(stringIndex: 1, fretRelative: 2, finger: 2),
            Position(stringIndex: 2, fretRelative: 0),
            Position(stringIndex: 3, fretRelative: 0),
            Position(stringIndex: 4, fretRelative: 0),
            Position(stringIndex: 5, fretRelative: 3, finger: 4),
          ],
        ),
        // E-shape @ 3rd: 3 5 5 4 3 3
        ChordVoicing(
          baseFret: 3,
          label: 'E-shape @ 3rd',
          barres: [Barre(fromString: 0, toStringIndex: 5, fretRelative: 1, finger: 1)],
          positions: [
            Position(stringIndex: 0, fretRelative: 1, finger: 1),
            Position(stringIndex: 1, fretRelative: 3, finger: 3),
            Position(stringIndex: 2, fretRelative: 3, finger: 4),
            Position(stringIndex: 3, fretRelative: 2, finger: 2),
            Position(stringIndex: 4, fretRelative: 1, finger: 1),
            Position(stringIndex: 5, fretRelative: 1, finger: 1),
          ],
        ),
        // A-shape @ 10th: x 10 12 12 12 10
        ChordVoicing(
          baseFret: 10,
          label: 'A-shape @ 10th',
          barres: [Barre(fromString: 1, toStringIndex: 5, fretRelative: 1, finger: 1)],
          positions: [
            Position(stringIndex: 0, fretRelative: 0, muted: true),
            Position(stringIndex: 1, fretRelative: 1, finger: 1),
            Position(stringIndex: 2, fretRelative: 3, finger: 3),
            Position(stringIndex: 3, fretRelative: 3, finger: 4),
            Position(stringIndex: 4, fretRelative: 3, finger: 2),
            Position(stringIndex: 5, fretRelative: 1, finger: 1),
          ],
        ),
      ],
    ),

    // G minor (barre only common)
    ChordQuality.min: ChordDefinition(
      root: 'G',
      quality: ChordQuality.min,
      voicings: const [
        // Em-shape @ 3rd: 3 5 5 3 3 3
        ChordVoicing(
          baseFret: 3,
          label: 'Em-shape @ 3rd',
          barres: [Barre(fromString: 0, toStringIndex: 5, fretRelative: 1, finger: 1)],
          positions: [
            Position(stringIndex: 0, fretRelative: 1, finger: 1),
            Position(stringIndex: 1, fretRelative: 3, finger: 3),
            Position(stringIndex: 2, fretRelative: 3, finger: 4),
            Position(stringIndex: 3, fretRelative: 1, finger: 1),
            Position(stringIndex: 4, fretRelative: 1, finger: 1),
            Position(stringIndex: 5, fretRelative: 1, finger: 1),
          ],
        ),
        // Am-shape @ 10th: x 10 12 12 11 10
        ChordVoicing(
          baseFret: 10,
          label: 'Am-shape @ 10th',
          barres: [Barre(fromString: 1, toStringIndex: 5, fretRelative: 1, finger: 1)],
          positions: [
            Position(stringIndex: 0, fretRelative: 0, muted: true),
            Position(stringIndex: 1, fretRelative: 1, finger: 1),
            Position(stringIndex: 2, fretRelative: 3, finger: 3),
            Position(stringIndex: 3, fretRelative: 3, finger: 4),
            Position(stringIndex: 4, fretRelative: 2, finger: 2),
            Position(stringIndex: 5, fretRelative: 1, finger: 1),
          ],
        ),
      ],
    ),

    // G7: 3 2 0 0 0 1
    ChordQuality.seven: ChordDefinition(
      root: 'G',
      quality: ChordQuality.seven,
      voicings: const [
        ChordVoicing(
          baseFret: 1,
          label: 'Open 7',
          positions: [
            Position(stringIndex: 0, fretRelative: 3, finger: 3),
            Position(stringIndex: 1, fretRelative: 2, finger: 2),
            Position(stringIndex: 2, fretRelative: 0),
            Position(stringIndex: 3, fretRelative: 0),
            Position(stringIndex: 4, fretRelative: 0),
            Position(stringIndex: 5, fretRelative: 1, finger: 1),
          ],
        ),
      ],
    ),
  },

  // ===================== A CHORDS =====================
  'A': {
    // A major: x 0 2 2 2 0
    ChordQuality.maj: ChordDefinition(
      root: 'A',
      quality: ChordQuality.maj,
      voicings: const [
        ChordVoicing(
          baseFret: 1,
          label: 'Open',
          positions: [
            Position(stringIndex: 0, fretRelative: 0, muted: true),
            Position(stringIndex: 1, fretRelative: 0),
            Position(stringIndex: 2, fretRelative: 2, finger: 1),
            Position(stringIndex: 3, fretRelative: 2, finger: 2),
            Position(stringIndex: 4, fretRelative: 2, finger: 3),
            Position(stringIndex: 5, fretRelative: 0),
          ],
        ),
        // E-shape @ 5th: 5 7 7 6 5 5
        ChordVoicing(
          baseFret: 5,
          label: 'E-shape @ 5th',
          barres: [Barre(fromString: 0, toStringIndex: 5, fretRelative: 1, finger: 1)],
          positions: [
            Position(stringIndex: 0, fretRelative: 1, finger: 1),
            Position(stringIndex: 1, fretRelative: 3, finger: 3),
            Position(stringIndex: 2, fretRelative: 3, finger: 4),
            Position(stringIndex: 3, fretRelative: 2, finger: 2),
            Position(stringIndex: 4, fretRelative: 1, finger: 1),
            Position(stringIndex: 5, fretRelative: 1, finger: 1),
          ],
        ),
      ],
    ),

    // A minor: x 0 2 2 1 0
    ChordQuality.min: ChordDefinition(
      root: 'A',
      quality: ChordQuality.min,
      voicings: const [
        ChordVoicing(
          baseFret: 1,
          label: 'Open',
          positions: [
            Position(stringIndex: 0, fretRelative: 0, muted: true),
            Position(stringIndex: 1, fretRelative: 0),
            Position(stringIndex: 2, fretRelative: 2, finger: 2),
            Position(stringIndex: 3, fretRelative: 2, finger: 3),
            Position(stringIndex: 4, fretRelative: 1, finger: 1),
            Position(stringIndex: 5, fretRelative: 0),
          ],
        ),
      ],
    ),

    // A7: x 0 2 0 2 0
    ChordQuality.seven: ChordDefinition(
      root: 'A',
      quality: ChordQuality.seven,
      voicings: const [
        ChordVoicing(
          baseFret: 1,
          label: 'Open 7',
          positions: [
            Position(stringIndex: 0, fretRelative: 0, muted: true),
            Position(stringIndex: 1, fretRelative: 0),
            Position(stringIndex: 2, fretRelative: 2, finger: 2),
            Position(stringIndex: 3, fretRelative: 0),
            Position(stringIndex: 4, fretRelative: 2, finger: 3),
            Position(stringIndex: 5, fretRelative: 0),
          ],
        ),
      ],
    ),
  },

  // ===================== B CHORDS (minimal starter) =====================
  'B': {
    // B major (A-shape @ 2nd): x 2 4 4 4 2
    ChordQuality.maj: ChordDefinition(
      root: 'B',
      quality: ChordQuality.maj,
      voicings: const [
        ChordVoicing(
          baseFret: 2,
          label: 'A-shape @ 2nd',
          barres: [Barre(fromString: 1, toStringIndex: 5, fretRelative: 1, finger: 1)],
          positions: [
            Position(stringIndex: 0, fretRelative: 0, muted: true),
            Position(stringIndex: 1, fretRelative: 1, finger: 1),
            Position(stringIndex: 2, fretRelative: 3, finger: 3),
            Position(stringIndex: 3, fretRelative: 3, finger: 4),
            Position(stringIndex: 4, fretRelative: 3, finger: 2),
            Position(stringIndex: 5, fretRelative: 1, finger: 1),
          ],
        ),
      ],
    ),

    // B minor (Am-shape @ 2nd): x 2 4 4 3 2
    ChordQuality.min: ChordDefinition(
      root: 'B',
      quality: ChordQuality.min,
      voicings: const [
        ChordVoicing(
          baseFret: 2,
          label: 'Am-shape @ 2nd',
          barres: [Barre(fromString: 1, toStringIndex: 5, fretRelative: 1, finger: 1)],
          positions: [
            Position(stringIndex: 0, fretRelative: 0, muted: true),
            Position(stringIndex: 1, fretRelative: 1, finger: 1),
            Position(stringIndex: 2, fretRelative: 3, finger: 3),
            Position(stringIndex: 3, fretRelative: 3, finger: 4),
            Position(stringIndex: 4, fretRelative: 2, finger: 2),
            Position(stringIndex: 5, fretRelative: 1, finger: 1),
          ],
        ),
      ],
    ),
  },
};

// ─────────────────────────────────────────────────────────────────────────────
// Helpers for consumers
// ─────────────────────────────────────────────────────────────────────────────

ChordDefinition? chordDefinition(String root, ChordQuality q) =>
    chordLibrary[root]?[q];

List<ChordVoicing> getVoicings(String root, ChordQuality q) =>
    chordDefinition(root, q)?.voicings ?? const [];

bool hasVoicings(String root, ChordQuality q) =>
    (chordLibrary[root]?[q]?.voicings.isNotEmpty ?? false);
